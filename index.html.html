<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Sprzeda≈º bilet√≥w</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Segoe UI,Arial;background:#f4f6fb;margin:0}
.container{max-width:720px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 10px 25px rgba(0,0,0,.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
button{border:none;border-radius:12px;padding:14px;font-size:16px;width:100%;margin-top:8px;cursor:pointer}
.primary{background:#4f46e5;color:#fff}
.cash{background:#16a34a;color:#fff}
.cardpay{background:#2563eb;color:#fff}
.muted{background:#e5e7eb}
.danger{background:#dc2626;color:#fff}
.stats{display:flex;justify-content:space-between;margin:6px 0}
.big{font-size:22px;font-weight:bold}
table{width:100%;border-collapse:collapse;font-size:14px}
td,th{padding:6px;border-bottom:1px solid #e5e7eb;text-align:center}

.modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    align-items:center;
    justify-content:center;
}
.modal-box{
    background:#fff;
    padding:20px;
    border-radius:16px;
    width:90%;
    max-width:320px;
    text-align:center;
}
</style>
</head>

<body>
<div class="container">

<h2>üéüÔ∏è Sprzeda≈º bilet√≥w</h2>

<div class="grid">
<div class="card">
<h3>Bilet lekcyjny</h3>
<div class="big">40 z≈Ç</div>
<button class="primary" onclick="start('Bilet lekcyjny',40)">Sprzedano</button>
</div>

<div class="card">
<h3>Bilet dzienny</h3>
<div class="big">60 z≈Ç</div>
<button class="primary" onclick="start('Bilet dzienny',60)">Sprzedano</button>
</div>
</div>

<div class="card">
<h3>üìä Raport dzienny</h3>
<div class="stats"><span>Lekcyjne</span><span id="lek">0</span></div>
<div class="stats"><span>Dzienne</span><span id="dz">0</span></div>
<hr>
<div class="stats"><span>Got√≥wka</span><span id="got">0 z≈Ç</span></div>
<div class="stats"><span>Karta</span><span id="kar">0 z≈Ç</span></div>
<hr>
<div class="stats big"><span>RAZEM</span><span id="raz">0 z≈Ç</span></div>

<button class="muted" onclick="window.print()">üñ®Ô∏è Druk / PDF</button>
<button class="muted" onclick="eksportCSV()">üì§ Pobierz raport (CSV)</button>
<button class="muted" onclick="wyslijMail()">üìß Wy≈õlij raport mailem</button>
<button class="muted" onclick="zerujDzien()">üîÅ Zeruj dzie≈Ñ</button>
<button class="danger" onclick="cofnij()">‚¨ÖÔ∏è Cofnij sprzeda≈º</button>
</div>

<div class="card">
<h3>üìã Transakcje</h3>
<table>
<thead><tr><th>Godz.</th><th>Bilet</th><th>P≈Çatno≈õƒá</th><th>Kwota</th></tr></thead>
<tbody id="lista"></tbody>
</table>
</div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modal-box">
<h3>Wybierz p≈Çatno≈õƒá</h3>
<button class="cash" onclick="zatwierdz('Got√≥wka')">Got√≥wka</button>
<button class="cardpay" onclick="zatwierdz('Karta')">Karta</button>
<button class="muted" onclick="zamknij()">Anuluj</button>
</div>
</div>

<script>
const email="krzysiekbabiarz0209@gmail.com";
const DB_NAME="sprzedazDB";
const STORE="transakcje";
const today=new Date().toISOString().slice(0,10);

let db;
let tempB=null,tempC=0;

/* ===== INIT DB ===== */
const req=indexedDB.open(DB_NAME,1);
req.onupgradeneeded=e=>{
    db=e.target.result;
    db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
    db=e.target.result;
    refresh();
};

/* ===== UI ===== */
function start(b,c){ tempB=b; tempC=c; modal.style.display="flex"; }
function zamknij(){ modal.style.display="none"; }

/* ===== CRUD ===== */
function addTransakcja(obj){
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).add(obj);
    tx.oncomplete=refresh;
}

function getAll(cb){
    const tx=db.transaction(STORE,"readonly");
    const req=tx.objectStore(STORE).getAll();
    req.onsuccess=()=>cb(req.result.filter(x=>x.data===today));
}

function clearToday(){
    getAll(list=>{
        const tx=db.transaction(STORE,"readwrite");
        const store=tx.objectStore(STORE);
        list.forEach(x=>store.delete(x.id));
        tx.oncomplete=refresh;
    });
}

function deleteLast(){
    getAll(list=>{
        if(!list.length) return alert("Brak sprzeda≈ºy");
        const last=list[list.length-1];
        const tx=db.transaction(STORE,"readwrite");
        tx.objectStore(STORE).delete(last.id);
        tx.oncomplete=refresh;
    });
}

/* ===== ACTIONS ===== */
function zatwierdz(p){
    addTransakcja({
        data:today,
        czas:new Date().toLocaleTimeString(),
        bilet:tempB,
        platnosc:p,
        kwota:tempC
    });
    zamknij();
}

function cofnij(){
    if(confirm("CofnƒÖƒá ostatniƒÖ sprzeda≈º?")) deleteLast();
}

function zerujDzien(){
    if(!confirm("ZamknƒÖƒá dzie≈Ñ i wyzerowaƒá sprzeda≈º?")) return;
    eksportCSV();
    clearToday();
}

/* ===== RENDER ===== */
function refresh(){
    getAll(list=>{
        let l=0,d=0,g=0,k=0,html="";
        list.forEach(x=>{
            if(x.bilet==="Bilet lekcyjny")l++;
            if(x.bilet==="Bilet dzienny")d++;
            if(x.platnosc==="Got√≥wka")g+=x.kwota;
            if(x.platnosc==="Karta")k+=x.kwota;
            html+=`<tr><td>${x.czas}</td><td>${x.bilet}</td><td>${x.platnosc}</td><td>${x.kwota} z≈Ç</td></tr>`;
        });
        lek.textContent=l; dz.textContent=d;
        got.textContent=g+" z≈Ç"; kar.textContent=k+" z≈Ç";
        raz.textContent=(g+k)+" z≈Ç"; lista.innerHTML=html;
    });
}

/* ===== EXPORT ===== */
function eksportCSV(){
    getAll(list=>{
        let g=0,k=0,csv="Godzina,Bilet,P≈Çatno≈õƒá,Kwota\n";
        list.forEach(x=>{
            csv+=`${x.czas},${x.bilet},${x.platnosc},${x.kwota}\n`;
            if(x.platnosc==="Got√≥wka")g+=x.kwota;
            if(x.platnosc==="Karta")k+=x.kwota;
        });
        csv+=`\nPODSUMOWANIE\nGot√≥wka,${g}\nKarta,${k}\nRAZEM,${g+k}\n`;
        download(csv,"raport_"+today+".csv");
    });
}

function wyslijMail(){
    const subject=encodeURIComponent("Raport sprzeda≈ºy "+today);
    const body=encodeURIComponent("Raport sprzeda≈ºy za dzie≈Ñ "+today);
    location.href=`mailto:${email}?subject=${subject}&body=${body}`;
}

function download(c,n){
    let a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([c]));
    a.download=n; a.click();
}
</script>

</body>
</html>
